

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>The LOTlib3 library - continued &#8212; The pLoT: A course</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '9_lab';</script>
    <link rel="shortcut icon" href="_static/favicon.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Reading" href="9_reading.html" />
    <link rel="prev" title="Lecture" href="9_lecture.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="evaluation.html">Evaluations &amp; project topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="howto.html">Running code in labs</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgments.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="askquestion.html">Ask a question!</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Foundations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="1_topfile.html">Week 1 - Introduction and Plan</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="1_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_reading.html">Reading</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="2_topfile.html">Week 2 - LoT Hypothesis I</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="2_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_lab.html">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_reading.html">Reading</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="3_topfile.html">Week 3 - LoT Hypothesis II</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="3_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_lab.html">Python refresher: Part II</a></li>

<li class="toctree-l2"><a class="reference internal" href="3_reading.html">Reading</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_supplementaryLecture.html">Supplementary content</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="4_topfile.html">Week 4 - Formal Grammars</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="4_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_lab.html">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_reading.html">Reading</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="5_topfile.html">Week 5 - Semantics</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="5_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="5_lab.html">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="5_reading.html">Reading</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="6_topfile.html">Week 6 - Bayes I</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="6_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="6_lab.html">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="6_reading.html">Reading</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="7_topfile.html">Week 7 - Bayes II</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="7_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="7_lab.html">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="7_reading.html">Reading</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">The probabilistic LoT</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="8_topfile.html">Week 8 - LOTlib3</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="8_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="8_lab.html">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="8_reading.html">Reading</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="9_topfile.html">Week 9 - Categorization</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="9_lecture.html">Lecture</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="9_reading.html">Reading</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="10_topfile.html">Week 10 - Case studies I</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="10_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_lab.html">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_reading.html">Reading</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="11_topfile.html">Week 11 - Case studies II</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="11_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_lab.html">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_lab_solved.html">Lab (Solved)</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_reading.html">Reading</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="12_topfile.html">Week 12 - DreamCoder and Conclusions</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="12_lecture.html">Lecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_lab.html">Lab</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_lab_solved.html">Lab (Solved)</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_reading.html">Reading</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/thelogicalgrammar/pLoT_course/blob/master/book/9_lab.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/thelogicalgrammar/pLoT_course" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/thelogicalgrammar/pLoT_course/issues/new?title=Issue%20on%20page%20%2F9_lab.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/9_lab.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>The LOTlib3 library - continued</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#primitives">Primitives</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#builtin-lotlib3-operations">Builtin LOTlib3 operations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-operations">Custom operations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonterminals-in-the-grammar">Nonterminals in the grammar</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-best-hypotheses">The best hypotheses</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hypotheses-as-functions">Hypotheses as functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lambdas">Lambdas</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#here-s-where-things-get-crazy">Here’s where things get crazy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-functions">Recursive functions</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="the-lotlib3-library-continued">
<h1>The LOTlib3 library - continued<a class="headerlink" href="#the-lotlib3-library-continued" title="Permalink to this headline">#</a></h1>
<blockquote>
<div><p><strong><strong>NOTE</strong></strong> This is based on Piantadosi’s introduction to LOTlib3, which you can find <a class="reference external" href="https://github.com/piantado/LOTlib3/blob/master/Documentation/Tutorial.md">here</a>.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="c1"># in colab</span>
    <span class="kn">import</span> <span class="nn">google.colab</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;In colab, downloading LOTlib3&#39;</span><span class="p">)</span>
    <span class="o">!</span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/thelogicalgrammar/LOTlib3
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># not in colab</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Not in colab!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Not in colab!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">LOTlib3.Grammar</span> <span class="kn">import</span> <span class="n">Grammar</span>
<span class="kn">from</span> <span class="nn">LOTlib3.Hypotheses.LOTHypothesis</span> <span class="kn">import</span> <span class="n">LOTHypothesis</span>
<span class="kn">from</span> <span class="nn">LOTlib3.DataAndObjects</span> <span class="kn">import</span> <span class="n">FunctionData</span>
<span class="kn">from</span> <span class="nn">LOTlib3.Samplers.MetropolisHastings</span> <span class="kn">import</span> <span class="n">MetropolisHastingsSampler</span>
<span class="kn">from</span> <span class="nn">LOTlib3.Miscellaneous</span> <span class="kn">import</span> <span class="n">logsumexp</span>
<span class="kn">from</span> <span class="nn">LOTlib3.Hypotheses.RecursiveLOTHypothesis</span> <span class="kn">import</span> <span class="n">RecursiveLOTHypothesis</span>
<span class="kn">from</span> <span class="nn">LOTlib3.Eval</span> <span class="kn">import</span> <span class="n">RecursionDepthException</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">exp</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<section id="primitives">
<h2>Primitives<a class="headerlink" href="#primitives" title="Permalink to this headline">#</a></h2>
<p>In the last lab, we have seen how to define custom interpreted operations in our LOTlib3 (interpreted) grammars: we can use arbitrary Python in the function argument. However, there are two more ways to make this more convenient when you need more complex interpretations: built-in LOTlib3 operations and your own custom operations. Let’s look at them in turn.</p>
<section id="builtin-lotlib3-operations">
<h3>Builtin LOTlib3 operations<a class="headerlink" href="#builtin-lotlib3-operations" title="Permalink to this headline">#</a></h3>
<p>LOTlib3 defines a number of primitive operations (you can find them in <code class="docutils literal notranslate"><span class="pre">LOTlib3.Primitives</span></code>). When these are supplied as the <code class="docutils literal notranslate"><span class="pre">&lt;FUNCTION&gt;</span></code> in grammar rule, they act as functions that get called. <strong>By convention, LOTlib3 internal primitives end in an underscore</strong>. Here is an example equivalent to the grammar from last week, but using LOTlib3 function calls:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">produce_grammar</span><span class="p">(</span><span class="n">numerals_weight</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    
    <span class="n">grammar</span> <span class="o">=</span> <span class="n">Grammar</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">)</span>
    
    <span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
        <span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;plus_&#39;</span><span class="p">,</span> 
        <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> 
        <span class="mf">1.0</span>
    <span class="p">)</span>
    
    <span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
        <span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;times_&#39;</span><span class="p">,</span> 
        <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> 
        <span class="mf">1.0</span>
    <span class="p">)</span>
    
    <span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
        <span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;divide_(float(</span><span class="si">%s</span><span class="s1">),float(</span><span class="si">%s</span><span class="s1">))&#39;</span><span class="p">,</span> 
        <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> 
        <span class="mf">1.0</span>
    <span class="p">)</span>
    
    <span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span>
        <span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;neg_&#39;</span><span class="p">,</span> 
        <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> 
        <span class="mf">1.0</span>
    <span class="p">)</span>
    
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">numerals_weight</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">grammar</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">produce_grammar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that when these are rendered into strings, they appear as function calls (and not just string substitutions to make python code) as in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">times_</span><span class="p">(</span><span class="n">plus_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">neg_</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">plus_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>There are many functions built-in to python, including a number of operations for manipulating sets, numbers, and logic. The code for <code class="docutils literal notranslate"><span class="pre">divide_</span></code> shows that it does not cast its arguments to floats: here we have to do so using string substitution as above.  For simple thing it is up to you to decide if you like to use the built in python operators (e.g. ‘+’) or the LOTLib3 primitive (‘plus_’) as they are basically the same.</p>
</section>
<section id="custom-operations">
<h3>Custom operations<a class="headerlink" href="#custom-operations" title="Permalink to this headline">#</a></h3>
<p>You can also create new primitives which extends the functionality of LOTlib3 in many interesting way. Unfortunately, if you just define a new function in the script, you cannot directly use it in the grammar. Let’s try, first defining the primitive as a regular function and then adding it as part of a rule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_silly_primitive</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">222</span>

<span class="n">grammar</span> <span class="o">=</span> <span class="n">produce_grammar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;my_silly_primitive_&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EXPR -&gt; my_silly_primitive_[&#39;EXPR&#39;]	w/ p=1.0
</pre></div>
</div>
</div>
</div>
<p>Let’s make sure that the rule was added:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="o">.</span><span class="n">display_rules</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EXPR -&gt; plus_[&#39;EXPR&#39;, &#39;EXPR&#39;]	w/ p=1.0
EXPR -&gt; times_[&#39;EXPR&#39;, &#39;EXPR&#39;]	w/ p=1.0
EXPR -&gt; divide_(float(%s),float(%s))[&#39;EXPR&#39;, &#39;EXPR&#39;]	w/ p=1.0
EXPR -&gt; neg_[&#39;EXPR&#39;]	w/ p=1.0
EXPR -&gt; 1	w/ p=2.0
EXPR -&gt; 2	w/ p=0.5
EXPR -&gt; 3	w/ p=0.2222222222222222
EXPR -&gt; 4	w/ p=0.125
EXPR -&gt; 5	w/ p=0.08
EXPR -&gt; 6	w/ p=0.05555555555555555
EXPR -&gt; 7	w/ p=0.04081632653061224
EXPR -&gt; 8	w/ p=0.03125
EXPR -&gt; 9	w/ p=0.024691358024691357
EXPR -&gt; my_silly_primitive_[&#39;EXPR&#39;]	w/ p=1.0
</pre></div>
</div>
</div>
</div>
<p>And now let’s try to interpret:</p>
<p>We can then generate new rules until we find something that contains <code class="docutils literal notranslate"><span class="pre">my_silly_primitive</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">generation</span> <span class="o">=</span> <span class="n">grammar</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">generation</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>plus_(1, divide_(float(1),float(1)))
</pre></div>
</div>
</div>
</div>
<p>And now, if we initialize a hypothesis with our generation and then try to call it, it will raise a NameError:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">h</span> <span class="o">=</span> <span class="n">LOTHypothesis</span><span class="p">(</span>
    <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="n">generation</span><span class="p">,</span>
    <span class="n">display</span><span class="o">=</span><span class="s2">&quot;lambda: </span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">h</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To make a custom function accessible to LOTlib3’s evaluator, use the <code class="docutils literal notranslate"><span class="pre">&#64;primitive</span></code> decorator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">LOTlib3.Eval</span> <span class="kn">import</span> <span class="n">primitive</span>

<span class="nd">@primitive</span>
<span class="k">def</span> <span class="nf">my_silly_primitive_</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">222</span>
</pre></div>
</div>
</div>
</div>
<p>Now if you use <code class="docutils literal notranslate"><span class="pre">my_stupid_primitive_</span></code> in a grammar rule, it can be “run” just like any normal python code</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">produce_grammar</span><span class="p">()</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;my_silly_primitive_&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EXPR -&gt; my_silly_primitive_[&#39;EXPR&#39;]	w/ p=1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="o">.</span><span class="n">display_rules</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EXPR -&gt; plus_[&#39;EXPR&#39;, &#39;EXPR&#39;]	w/ p=1.0
EXPR -&gt; times_[&#39;EXPR&#39;, &#39;EXPR&#39;]	w/ p=1.0
EXPR -&gt; divide_(float(%s),float(%s))[&#39;EXPR&#39;, &#39;EXPR&#39;]	w/ p=1.0
EXPR -&gt; neg_[&#39;EXPR&#39;]	w/ p=1.0
EXPR -&gt; 1	w/ p=10.0
EXPR -&gt; 2	w/ p=2.5
EXPR -&gt; 3	w/ p=1.1111111111111112
EXPR -&gt; 4	w/ p=0.625
EXPR -&gt; 5	w/ p=0.4
EXPR -&gt; 6	w/ p=0.2777777777777778
EXPR -&gt; 7	w/ p=0.20408163265306123
EXPR -&gt; 8	w/ p=0.15625
EXPR -&gt; 9	w/ p=0.12345679012345678
EXPR -&gt; my_silly_primitive_[&#39;EXPR&#39;]	w/ p=1.0
</pre></div>
</div>
</div>
</div>
<p>It is generally more friendly to give it an underscore to make sure it’s not confused for a normal python function.</p>
</section>
</section>
<section id="nonterminals-in-the-grammar">
<h2>Nonterminals in the grammar<a class="headerlink" href="#nonterminals-in-the-grammar" title="Permalink to this headline">#</a></h2>
<p>Up to this point, our grammar only contained a single non-terminal symbol, <code class="docutils literal notranslate"><span class="pre">EXPR</span></code>, representing a number. But what if we have more than one kind of expression, e.g., numbers <em>and</em> booleans? LOTlib3 can deal with this easily with the arguments to <code class="docutils literal notranslate"><span class="pre">grammar.add_rule</span></code> we saw in the last lab. Recall from last week that these are its arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span> <span class="o">&lt;</span><span class="n">NONTERMINAL</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">FUNCTION</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">ARGUMENTS</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">PROBABILITY</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here’s how it works:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">&lt;NONTERMINAL&gt;</span></code> part of each grammar rule can be viewed as specifying the <em>return type</em> of the function that rule correspond to. For instance, if the rule outputs something of numerical type, this would be <code class="docutils literal notranslate"><span class="pre">EXPR</span></code>, and it the rule outputs something of boolean type, we could call it <code class="docutils literal notranslate"><span class="pre">BOOL</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">&lt;ARGUMENTS&gt;</span></code> can be viewed as the types of the <em>input arguments</em>.</p></li>
</ul>
<p>Thus, what a grammar mainly does is ensure that the primitives all get arguments of the correct types. Let’s see this in action: suppose we had two kinds of things: booleans (BOOL) and numbers (EXPR). We might write a grammar like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">Grammar</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">)</span>

<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;plus_&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;times_&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># Use something that renders into if statements in real python</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> if </span><span class="si">%s</span><span class="s1"> else </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;BOOL&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># Now how do we get a boolean?</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;BOOL&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> &gt; </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;BOOL&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> &gt;= </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># And a terminal</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EXPR -&gt; 2	w/ p=4.0
</pre></div>
</div>
</div>
</div>
<p>Here, the second argument to the <code class="docutils literal notranslate"><span class="pre">if</span></code> line must be a <code class="docutils literal notranslate"><span class="pre">BOOL</span></code>, and so we have given LOTlib3 a way to create code that returns <code class="docutils literal notranslate"><span class="pre">BOOL</span></code>s. It just happens that this code is a comparison of numbers, or <code class="docutils literal notranslate"><span class="pre">EXPR</span></code>s. Let’s look at some generations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">grammar</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
1
plus_((1 if (1 &gt;= times_((2 if (2 &gt; 2) else times_(2, 1)), 2)) else 2), 2)
times_(times_(2, 1), 2)
1
plus_(1, 2)
2
2
2
2
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-best-hypotheses">
<h2>The best hypotheses<a class="headerlink" href="#the-best-hypotheses" title="Permalink to this headline">#</a></h2>
<p>Now let’s go back to how we can store the results of the inference. First, let’s define the Grammar and Hypothesis again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">produce_grammar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># define a hypothesis</span>
<span class="k">class</span> <span class="nc">MyHypothesis</span><span class="p">(</span><span class="n">LOTHypothesis</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">LOTHypothesis</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span> 
            <span class="n">display</span><span class="o">=</span><span class="s2">&quot;lambda: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_single_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the loglikelihood function P(datum | self)&quot;&quot;&quot;</span>
        <span class="n">prob_of_random_number</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">datum</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">(</span><span class="o">*</span><span class="n">datum</span><span class="o">.</span><span class="n">input</span><span class="p">)</span> <span class="o">==</span> <span class="n">datum</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">log</span><span class="p">(</span><span class="n">prob_of_random_number</span> <span class="o">+</span> <span class="n">datum</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">log</span><span class="p">(</span><span class="n">prob_of_random_number</span><span class="p">)</span> 

<span class="n">data</span> <span class="o">=</span> <span class="p">[</span> 
    <span class="n">FunctionData</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[],</span> 
        <span class="n">output</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.999</span>
    <span class="p">)</span> 
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Very often, models in LOTlib3 approximate the full posterior distribution <span class="math notranslate nohighlight">\(P(H|D)\)</span> using the highest posterior hypotheses. There are two main ways to do this. One is a class named <code class="docutils literal notranslate"><span class="pre">LOTlib3.TopN</span></code> which acts like a set–you can add to it, but it keeps only the ones with highest <code class="docutils literal notranslate"><span class="pre">posterior_score</span></code> (or whatever “key” is set). It will return them to you in a sorted order:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">LOTlib3.TopN</span> <span class="kn">import</span> <span class="n">TopN</span>

<span class="c1"># store the top N</span>
<span class="n">tn</span> <span class="o">=</span> <span class="n">TopN</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">MyHypothesis</span><span class="p">()</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">MetropolisHastingsSampler</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">tn</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can see the best formulas as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">tn</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">posterior_score</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-12.888815174461108 lambda: times_(times_(4, 1), 3) 12
-12.888815174461108 lambda: times_(divide_(float(4),float(1)), 3) 12.0
-12.888815174461108 lambda: times_(4, times_(1, 3)) 12
-12.888815174461108 lambda: times_(plus_(2, 2), 3) 12
-12.313451029557548 lambda: times_(plus_(1, 3), 3) 12
-12.313451029557548 lambda: times_(plus_(3, 1), 3) 12
-12.175493704674896 lambda: 1 1
-12.07788495824478 lambda: times_(4, plus_(1, 2)) 12
-12.07788495824478 lambda: times_(4, plus_(2, 1)) 12
-9.261093602057727 lambda: times_(4, 3) 12
</pre></div>
</div>
</div>
</div>
<p>There’s also a friendly way to interface with <code class="docutils literal notranslate"><span class="pre">TopN</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">MetropolisHastingsSampler</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">tn</span> <span class="o">&lt;&lt;</span> <span class="n">h</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">tn</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">posterior_score</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-12.888815174461108 lambda: times_(times_(4, 1), 3) 12
-12.888815174461108 lambda: times_(divide_(float(4),float(1)), 3) 12.0
-12.888815174461108 lambda: times_(4, times_(1, 3)) 12
-12.888815174461108 lambda: times_(plus_(2, 2), 3) 12
-12.313451029557548 lambda: times_(plus_(1, 3), 3) 12
-12.313451029557548 lambda: times_(plus_(3, 1), 3) 12
-12.175493704674896 lambda: 1 1
-12.07788495824478 lambda: times_(4, plus_(1, 2)) 12
-12.07788495824478 lambda: times_(4, plus_(2, 1)) 12
-9.261093602057727 lambda: times_(4, 3) 12
</pre></div>
</div>
</div>
</div>
<p>Productions the results in the output 12 have high posterior scores and are in general among the best hypotheses.  However, some very simple and short programs like a single number output (like 0) might still appear among the “top” hypotheses. This is because the prior might make them still quite likely given the specified level of noise <span class="math notranslate nohighlight">\(\alpha\)</span>, i.e., the observation might have been a mistake. This shows the importance of thinking about the nature of your prior and the likelihood function for your problem.</p>
</section>
<section id="hypotheses-as-functions">
<h2>Hypotheses as functions<a class="headerlink" href="#hypotheses-as-functions" title="Permalink to this headline">#</a></h2>
<p>When we defined MyHypothesis, we passed <code class="docutils literal notranslate"><span class="pre">display=&quot;lambda:</span> <span class="pre">%s&quot;</span></code> to <code class="docutils literal notranslate"><span class="pre">LOTHypothesis.__init__</span></code>. That meant that a hypothesis was not a function of any arguments, since the <code class="docutils literal notranslate"><span class="pre">lambda</span></code> has no arguments. You may have noticed that when a hypothesis is converting to a string (for printing or evaling) it acquires this additional <code class="docutils literal notranslate"><span class="pre">lambda</span></code> on the outside, indicating that the hypothesis was a function of no arguments, or a <a class="reference external" href="https://en.wikipedia.org/wiki/Thunk">thunk</a>.</p>
<p>However, often we want our hypotheses to be a function with arguments! Then, our observations can be sets of (input, output) tuples, and the hypothesis can be a function that given each input returns each output. Let’s define a new grammar that allows us to encode functions, and a corresponding MyHypothesis that requires an argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">Grammar</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">)</span>

<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> + </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> * </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(float(</span><span class="si">%s</span><span class="s1">) / float(</span><span class="si">%s</span><span class="s1">))&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(-</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># Now define how the grammar uses x. The string &#39;x&#39; must</span>
<span class="c1"># be the same as used in the args below.</span>
<span class="c1"># Basically, x will now sometimes appear in the formulas,</span>
<span class="c1"># and in those cases it can be bound in Hypothesis.</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> 

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">10.0</span><span class="o">/</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s define the Hypothesis:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyHypothesisX</span><span class="p">(</span><span class="n">LOTHypothesis</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">LOTHypothesis</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span> 
            <span class="c1"># NOTE: now we pass an argument</span>
            <span class="c1"># to the lambda function</span>
            <span class="n">display</span><span class="o">=</span><span class="s2">&quot;lambda x: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># try to do it from the superclass</span>
            <span class="k">return</span> <span class="n">LOTHypothesis</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="c1"># and if we get an error, return nan</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_single_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datum</span><span class="p">):</span>
        <span class="n">call_output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="o">*</span><span class="n">datum</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">call_output</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">call_output</span> <span class="o">==</span> <span class="n">datum</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">log</span><span class="p">((</span><span class="mf">1.0</span><span class="o">-</span><span class="n">datum</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span> <span class="o">+</span> <span class="n">datum</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">log</span><span class="p">((</span><span class="mf">1.0</span><span class="o">-</span><span class="n">datum</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, when the hypothesis renders, it comes with a <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">x</span></code> in front, rather than just a <code class="docutils literal notranslate"><span class="pre">lambda</span></code>. The grammar now has to allow the argument (<code class="docutils literal notranslate"><span class="pre">x</span></code>) to be produced in expressions.</p>
<p>We also define the <code class="docutils literal notranslate"><span class="pre">datum.input</span></code> so that it has an input, which gets bound to <code class="docutils literal notranslate"><span class="pre">x</span></code> when the function is evaluated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now our data takes input x=3 and maps it to 12</span>
<span class="c1"># What could the function be?</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[</span> 
    <span class="n">FunctionData</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> 
        <span class="n">output</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.99</span>
    <span class="p">)</span> 
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s actually run this and see what it comes up with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tn</span> <span class="o">=</span> <span class="n">TopN</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> 
<span class="n">h0</span> <span class="o">=</span> <span class="n">MyHypothesisX</span><span class="p">()</span>

<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">MetropolisHastingsSampler</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">tn</span> <span class="o">&lt;&lt;</span> <span class="n">h</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">tn</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">posterior_score</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-11.84347278665917 lambda x: (9 + 3)
-11.373469157413435 lambda x: (9 + x)
-11.373469157413435 lambda x: (x + 9)
-11.314361217957266 lambda x: 1
-10.554758753878144 lambda x: (2 * 6)
-10.457178425539281 lambda x: (4 * 3)
-10.457178425539281 lambda x: (3 * 4)
-9.987174796293544 lambda x: (x * 4)
-9.987174796293544 lambda x: (4 * x)
-9.928066856837376 lambda x: 0
</pre></div>
</div>
</div>
</div>
<p>Why does this matter? Well now instead of just explaining the data we saw, we can use the hypothesis to generalize to <em>new</em>, unseen data. For instance, we can take each hypothesis and see what it has to say about other numbers</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For each top N hypothesis, we&#39;ll see what it maps 0..9 to </span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">tn</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">posterior_score</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-11.84347278665917 lambda x: (9 + 3) [12, 12, 12, 12, 12, 12, 12, 12, 12, 12]
-11.373469157413435 lambda x: (9 + x) [9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
-11.373469157413435 lambda x: (x + 9) [9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
-11.314361217957266 lambda x: 1 [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
-10.554758753878144 lambda x: (2 * 6) [12, 12, 12, 12, 12, 12, 12, 12, 12, 12]
-10.457178425539281 lambda x: (4 * 3) [12, 12, 12, 12, 12, 12, 12, 12, 12, 12]
-10.457178425539281 lambda x: (3 * 4) [12, 12, 12, 12, 12, 12, 12, 12, 12, 12]
-9.987174796293544 lambda x: (x * 4) [0, 4, 8, 12, 16, 20, 24, 28, 32, 36]
-9.987174796293544 lambda x: (4 * x) [0, 4, 8, 12, 16, 20, 24, 28, 32, 36]
-9.928066856837376 lambda x: 0 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
</pre></div>
</div>
</div>
</div>
<p>Thus, we have taken a single data point and used it to infer a function that can <em>generalize</em> to new, unseen data or arguments. Note, though, that there is no requirement that <code class="docutils literal notranslate"><span class="pre">x</span></code> is used in each hypothesis. (If we wanted that, a LOTlib3ian way to do it would be to modify the prior to assign trees that don’t use <code class="docutils literal notranslate"><span class="pre">x</span></code> to have <code class="docutils literal notranslate"><span class="pre">-Infinity</span></code> log prior).</p>
<p>Just for fun here, let’s take the posterior predictive and see how likely we are to generalize this function to every other number.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tn</span> <span class="o">=</span> <span class="n">TopN</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> 

<span class="n">h0</span> <span class="o">=</span> <span class="n">MyHypothesisX</span><span class="p">()</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">MetropolisHastingsSampler</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">tn</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># store these in a list (tn.get_all is defaultly a generator)</span>
<span class="n">hypotheses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tn</span><span class="o">.</span><span class="n">get_all</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the normalizing constant</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">logsumexp</span><span class="p">([</span><span class="n">h</span><span class="o">.</span><span class="n">posterior_score</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hypotheses</span><span class="p">])</span>

<span class="c1"># Now compute a matrix of how likely each input is to go</span>
<span class="c1"># to each output.</span>
<span class="c1"># An MxM matrix of values</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># The probability of generalizing</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">M</span><span class="p">,</span><span class="n">M</span><span class="p">))</span>

<span class="c1"># Now add in each hypothesis&#39; predictive</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hypotheses</span><span class="p">:</span>
    <span class="c1"># the (normalized) posterior probability of this hypothesis</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">posterior_score</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># only keep those that are in the right range</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">output</span> <span class="o">&lt;</span> <span class="n">M</span><span class="p">:</span>
            <span class="n">G</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">output</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">p</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># And show the output</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Input&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Output&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5733127d33aaaa166ead03eec449bd92cca6b527e7586830eb058b4f497039d0.png" src="_images/5733127d33aaaa166ead03eec449bd92cca6b527e7586830eb058b4f497039d0.png" />
</div>
</div>
<p>As you can see from the complexity of this array which shows the probabilities for different outputs given different inputs, observing that some (unseen) function maps 3<span class="math notranslate nohighlight">\(\to\)</span>12 gives rise to nontrivial beliefs about the function underlying this transformation.</p>
</section>
<section id="lambdas">
<h2>Lambdas<a class="headerlink" href="#lambdas" title="Permalink to this headline">#</a></h2>
<p>The power of this kind of representation comes not only from an ability to learn such simple functions, but to also learn functions with new kinds of abstractions. In programming languages, the simplest kind of abstraction is a variable–a value that is stored for later use. The variable <code class="docutils literal notranslate"><span class="pre">x</span></code> is created above on the level of a LOTHypothesis, but where things get more interesting is when the lower down values in a grammar can be used to define variables. Let’s first redefine the simple arithmetic function grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">Grammar</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">)</span>

<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> + </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> * </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(float(</span><span class="si">%s</span><span class="s1">) / float(</span><span class="si">%s</span><span class="s1">))&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(-</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> 

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="c1"># We&#39;ll make these lower probability so we can see more lambdas below</span>
    <span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">5.0</span><span class="o">/</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s add two additional pieces that allow lambda abstraction in the grammar. First, we define the application of a new nonterminal, <code class="docutils literal notranslate"><span class="pre">FUNC</span></code>, to a term <code class="docutils literal notranslate"><span class="pre">EXPR</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">)(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;FUNC&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EXPR -&gt; (%s)(%s)[&#39;FUNC&#39;, &#39;EXPR&#39;]	w/ p=1.0
</pre></div>
</div>
</div>
</div>
<p>Then, we define a rule for replacing <code class="docutils literal notranslate"><span class="pre">FUNC</span></code>, which should be thought of as a function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;FUNC&#39;</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">bv_type</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FUNC -&gt; lambda[&#39;EXPR&#39;]	w/ p=1.0,	BV:EXPR;None;y
</pre></div>
</div>
</div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">lambda</span></code> is a special LOTlib3 keyword that <em>introduces a bound variable</em> with a unique name in expanding the <code class="docutils literal notranslate"><span class="pre">&lt;ARGUMENT&gt;</span></code>s. In other words, when the grammar happens to sample a rule whose <code class="docutils literal notranslate"><span class="pre">&lt;FUNCTION&gt;</span></code> is <code class="docutils literal notranslate"><span class="pre">'lambda'</span></code>, it creates a new variable name, allows <code class="docutils literal notranslate"><span class="pre">bv_type</span></code> to expand to this variable, expands the <code class="docutils literal notranslate"><span class="pre">&lt;ARGUMENTS&gt;</span></code> to <code class="docutils literal notranslate"><span class="pre">lambda</span></code> (here, <code class="docutils literal notranslate"><span class="pre">EXPR</span></code>), and then removes the rule from the grammar. Let’s look at some productions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">grammar</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(-1)
3
(lambda y1: 1)((lambda y2: y2)((lambda y3: (-y3))(1)))
(2 + (lambda y2: y2)(6))
1
((-(-1)) + (-x))
1
(2 * (lambda y2: (y2 * y2))(x))
(2 + (lambda y2: 1)(1))
(lambda y1: y1)(6)
</pre></div>
</div>
</div>
</div>
<p>Now some of the trees contain <code class="docutils literal notranslate"><span class="pre">lambda</span></code> expressions, which bind a variable (defaultly rendered as <code class="docutils literal notranslate"><span class="pre">y1</span></code>). The variable <code class="docutils literal notranslate"><span class="pre">y1</span></code> can only be used below its corresponding lambda, making the grammar in LOTlib3 technically not context-free, but very weakly context-sensitive. The variables like <code class="docutils literal notranslate"><span class="pre">y1</span></code> are called <strong>bound variables</strong> in LOTlib3. Note that they are numbered by their height in the tree, making them unique to the nodes below, but neither sequential, nor unique in the whole tree (underlyingly, they have unique names no matter what, but not when rendered into strings).</p>
<p>These bound variables count towards the prior (when using <code class="docutils literal notranslate"><span class="pre">grammar.log_probability</span></code>) in exactly the way they should: when a nonterminal (specified in <code class="docutils literal notranslate"><span class="pre">bv_type</span></code>) can expand to a given bound variable, that costs probability, and other expansions must lose probability. The default in LOTlib3 is to always renormalize the probabilities specified. Note that in the <code class="docutils literal notranslate"><span class="pre">add_rule</span></code> command, we can change the probability that a <code class="docutils literal notranslate"><span class="pre">EXPR</span></code><span class="math notranslate nohighlight">\(\to\)</span> <code class="docutils literal notranslate"><span class="pre">yi</span></code> rule has by passing in a bv_p argument:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make using yi 10x more likely than before</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;FUNC&#39;</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">bv_type</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="n">bv_p</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Lambdas like these play the role of variable declarations in a normal programming language. But note that the variables aren’t guaranteed to be useful. In fact, very often variables are stupid, as in the expression</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="k">lambda</span> <span class="n">y1</span><span class="p">:</span> <span class="n">y1</span><span class="p">)((</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>where the lambda defines a variable that is used immediately without modification. This expression is therefore equivalent to</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>in terms of its function, but not in terms of its prior.</p>
<p>We can also change the name that bound variables get by setting <code class="docutils literal notranslate"><span class="pre">bv_prefix</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;FUNC&#39;</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">bv_type</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="n">bv_prefix</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>will make bound variables named <code class="docutils literal notranslate"><span class="pre">v1</span></code>, <code class="docutils literal notranslate"><span class="pre">v2</span></code>, etc.</p>
</section>
<section id="here-s-where-things-get-crazy">
<h2>Here’s where things get crazy<a class="headerlink" href="#here-s-where-things-get-crazy" title="Permalink to this headline">#</a></h2>
<p>Of course, the true art of lambdas is not just that they can define variables, but that the variables themselves can be functions! This corresponds to <em>function declarations</em> in ordinary programming languages. If this is foreign or weird, I’d suggest reading <a class="reference external" href="https://mitpress.mit.edu/sicp/">The Structure and Interpretation of Computer Programs</a>.</p>
<p>To define lambdas as functions, we only need to specify a <code class="docutils literal notranslate"><span class="pre">bv_args</span></code> list in the <code class="docutils literal notranslate"><span class="pre">lambda</span></code> declaration. <code class="docutils literal notranslate"><span class="pre">bv_args</span></code> is the type of arguments that are passed to each use of a bound variable each time it is used. But… then we have a problem of needing to bind that variable to something. If <code class="docutils literal notranslate"><span class="pre">yi</span></code> is itself a function of an EXPR, then its argument <em>also</em> has to be a function. That requires two lambdas. Here’s how it works:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">Grammar</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">)</span>

<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> + </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> * </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(float(</span><span class="si">%s</span><span class="s1">) / float(</span><span class="si">%s</span><span class="s1">))&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(-</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>  

<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">5.0</span><span class="o">/</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Allow ourselves to define functions. This means creating a bound </span>
<span class="c1"># variable that can be bound to a FUNC. Where, the bound variable</span>
<span class="c1"># is defined (here, FUNCDEF) we are allowed to use it. </span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;((</span><span class="si">%s</span><span class="s1">)(</span><span class="si">%s</span><span class="s1">))&#39;</span><span class="p">,</span>  <span class="p">[</span><span class="s1">&#39;FUNCDEF&#39;</span><span class="p">,</span> <span class="s1">&#39;FUNC&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># The function definition has a bound variable who can be applied as</span>
<span class="c1"># a function, whose arguments are an EXPR (set by the type of the FUNC above)</span>
<span class="c1"># and whose name is F, and who when applied to an EXPR returns an EXPR</span>
<span class="c1"># We&#39;ll also set bv_p here. Feel free to play with it and see what that does. </span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;FUNCDEF&#39;</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">bv_type</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="n">bv_args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="n">bv_prefix</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

<span class="c1"># and we have to say what a FUNC is. It&#39;s a function (lambda) from an EXPR to an EXPR</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;FUNC&#39;</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">bv_type</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>FUNC -&gt; lambda[&#39;EXPR&#39;]	w/ p=1.0,	BV:EXPR;None;y
</pre></div>
</div>
</div>
</div>
<p>Let’s look at some hypotheses. Here, we’ll show only those that use <code class="docutils literal notranslate"><span class="pre">F1</span></code> as a function (thus contain the string <code class="docutils literal notranslate"><span class="pre">&quot;F1(&quot;</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span> 

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">grammar</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;F1\(&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((lambda F1: F1(F1(F1(F1(F1(1))))))(lambda y1: y1))
((lambda F1: (-F1(F1(6))))(lambda y1: y1))
((lambda F1: F1(F1(((lambda F5: F5(F1(((lambda F9: 9)(lambda y9: F5(F1((-y9))))))))(lambda y5: y5)))))(lambda y1: 4))
((lambda F1: ((lambda F3: F3(4))(lambda y3: F1((x * y3)))))(lambda y1: y1))
((lambda F1: F1(F1(F1(1))))(lambda y1: y1))
((lambda F1: (float((float(((lambda F5: 1)(lambda y5: y5))) / float(F1(((lambda F6: F1((x + (F6(F6(2)) + F1(1)))))(lambda y6: F1((-(float((y6 + 6)) / float(1)))))))))) / float(F1(2))))(lambda y1: y1))
((lambda F1: F1(1))(lambda y1: (y1 + (8 * (float(y1) / float((3 * (y1 * x))))))))
((lambda F1: F1(F1((F1((2 * F1(((lambda F9: (F9((float(F9(3)) / float(1))) * x))(lambda y9: 1))))) + F1(1)))))(lambda y1: 1))
((lambda F1: F1(F1((-2))))(lambda y1: 5))
((lambda F1: F1(1))(lambda y1: y1))
((lambda F1: F1(1))(lambda y1: (float((((lambda F5: F5(y1))(lambda y5: y1)) + 1)) / float(y1))))
((lambda F1: F1((6 * ((lambda F5: F5(F5(F1(F5(F1(F5(1)))))))(lambda y5: y5)))))(lambda y1: 1))
((lambda F1: (((lambda F4: F1(F1(1)))(lambda y4: y4)) * F1(4)))(lambda y1: ((lambda F3: (1 * x))(lambda y3: y1))))
((lambda F1: (float((F1((F1(2) + (F1(1) + F1(F1(F1(F1(F1(F1(F1(2)))))))))) + F1((float(F1(1)) / float(F1((-(1 + x)))))))) / float(4)))(lambda y1: (-(y1 + y1))))
((lambda F1: F1(x))(lambda y1: (y1 + 1)))
((lambda F1: (float(F1(2)) / float(F1(1))))(lambda y1: y1))
((lambda F1: (float(F1(F1((-4)))) / float((1 + 1))))(lambda y1: x))
((lambda F1: F1(F1(((lambda F5: 1)(lambda y5: 1)))))(lambda y1: ((y1 + 1) + (y1 * (float(2) / float((y1 * (y1 + y1))))))))
</pre></div>
</div>
</div>
</div>
<p>For instance, this code might generate the following expression, which is obscure, though acceptable, python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">((</span><span class="k">lambda</span> <span class="n">F1</span><span class="p">:</span> <span class="n">F1</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">))(</span><span class="k">lambda</span> <span class="n">y1</span><span class="p">:</span> <span class="n">y1</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>Here, we have define a variable <code class="docutils literal notranslate"><span class="pre">F1</span></code> that really represents the <em>function</em> <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">y1:</span> <span class="pre">y1+3</span></code>. The value that is returned is the value of applying <code class="docutils literal notranslate"><span class="pre">F1</span></code> to the overall hypothesis value <code class="docutils literal notranslate"><span class="pre">x</span></code> plus <code class="docutils literal notranslate"><span class="pre">1</span></code>. Note that LOTlib3 here has correctly used <code class="docutils literal notranslate"><span class="pre">F1</span></code> in a context where an <code class="docutils literal notranslate"><span class="pre">EXPR</span></code> is needed (due to <code class="docutils literal notranslate"><span class="pre">bv_type='EXPR'</span></code> on <code class="docutils literal notranslate"><span class="pre">FUNCDEF</span></code>). It knows that the argument to <code class="docutils literal notranslate"><span class="pre">F1</span></code> is also an EXPR, which here happens to be expanded to <code class="docutils literal notranslate"><span class="pre">x+1</span></code>. It also knows that <code class="docutils literal notranslate"><span class="pre">F1</span></code> is itself a function, and it binds this function (through the outermost apply) to <code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">y1:</span> <span class="pre">y1+3</span></code>. LOTlib3 knows that <code class="docutils literal notranslate"><span class="pre">F1</span></code> can only be used in the left hand side of this apply, and <code class="docutils literal notranslate"><span class="pre">y1</span></code> can only be used on the right. This holds even if multiple bound variables of different types are generated.</p>
<p>This ability to define functions provides some of the most interesting learning dynamics for the model. A nice example is provided in <code class="docutils literal notranslate"><span class="pre">LOTlib3.Examples.Magnetism</span></code>, where learners take data and learn predicates classifying observable objects into two kinds, as well as laws stated over those kinds.</p>
</section>
<section id="recursive-functions">
<h2>Recursive functions<a class="headerlink" href="#recursive-functions" title="Permalink to this headline">#</a></h2>
<p>Well that’s wonderful, but what if we want a function to refer to <em>itself</em>? This is common in programming languages in the form of <a class="reference external" href="https://en.wikipedia.org/wiki/Recursion_%28computer_science%29">recursive</a> definitions. This takes a little finagling in the LOTlib3 internals (through ambitious use of the <a class="reference external" href="https://en.wikipedia.org/wiki/Fixed-point_combinator#Fixed_point_combinators_in_lambda_calculus">Y-combinator</a>) which you don’t have to worry about. There is a class that implements recursion straightforwardly: <code class="docutils literal notranslate"><span class="pre">RecursiveLOTHypothesis</span></code>. Internally, hypothesis of this type always have an argument (defaultly called <code class="docutils literal notranslate"><span class="pre">recurse_</span></code>) which binds to themselves!</p>
<p>Consider a simple example. Let’s first define the grammar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grammar</span> <span class="o">=</span> <span class="n">Grammar</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;EXPR&#39;</span><span class="p">)</span>

<span class="c1"># for simplicity, two operations</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> + </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> * </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># we&#39;ll just allow two terminals for simplicity</span>
<span class="c1"># We have to upweight them a little to keep things well-defined</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span> 
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span> 

<span class="c1"># If we&#39;re going to allow recursion, we better have a base case</span>
<span class="c1"># But this probably requires an &quot;if&quot; statement. LOTlib3&#39;s &quot;if_&quot; </span>
<span class="c1"># primitive will do the trick</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%s</span><span class="s1"> if </span><span class="si">%s</span><span class="s1"> else </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;BOOL&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPR&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># and we need to define a boolean. For now, let&#39;s just check</span>
<span class="c1"># if x=1</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;BOOL&#39;</span><span class="p">,</span> <span class="s1">&#39;x==1&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># and the recursive operation -- I am myself a function</span>
<span class="c1"># from EXPR to EXPR, so recurse should be as well</span>
<span class="n">grammar</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="s1">&#39;EXPR&#39;</span><span class="p">,</span> <span class="s1">&#39;recurse_&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x-1&#39;</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>EXPR -&gt; recurse_[&#39;x-1&#39;]	w/ p=1.0
</pre></div>
</div>
</div>
</div>
<p>Then, let’s define a hypothesis:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyRecursiveHypothesis</span><span class="p">(</span><span class="n">RecursiveLOTHypothesis</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">RecursiveLOTHypothesis</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="s2">&quot;lambda recurse_, x: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, let’s look at some examples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">MyRecursiveHypothesis</span><span class="p">()</span>

    <span class="c1"># Now when we call h, something funny may happen: we may get</span>
    <span class="c1"># an exception for recursing too deep. If this happens for some </span>
    <span class="c1"># reasonable xes, let&#39;s not print the hypothesis -- it must not </span>
    <span class="c1"># be well-defined</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># try our function out</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)))</span>
    <span class="k">except</span> <span class="n">RecursionDepthException</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># if we succeed, let&#39;s only show hypotheses that use recurse:</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;recurse_\(&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">h</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>lambda recurse_, x: ((1 if x==1 else recurse_(x-1)) + x)
[2, 4, 7, 11, 16, 22, 29, 37, 46]
lambda recurse_, x: ((x if x==1 else (x if x==1 else recurse_(x-1))) + x)
[2, 4, 7, 11, 16, 22, 29, 37, 46]
lambda recurse_, x: (recurse_(x-1) if x==1 else x)
[0, 2, 3, 4, 5, 6, 7, 8, 9]
</pre></div>
</div>
</div>
</div>
<p>Note that there is nothing special about the <code class="docutils literal notranslate"><span class="pre">recurse_</span></code> name: it can be changed by setting <code class="docutils literal notranslate"><span class="pre">recurse=...</span></code> in <code class="docutils literal notranslate"><span class="pre">RecursiveLOTHypothesis.__init__</span></code>, but then the name should also be changed in the grammar. In this tutorial, we have only looked at defining the grammar, not in inferring recursive hypotheses. <code class="docutils literal notranslate"><span class="pre">LOTlib3.Examples.Number</span></code> is an example of learning a genuinely recursive function from data.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "lot"
        },
        kernelOptions: {
            name: "lot",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'lot'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="9_lecture.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lecture</p>
      </div>
    </a>
    <a class="right-next"
       href="9_reading.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Reading</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#primitives">Primitives</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#builtin-lotlib3-operations">Builtin LOTlib3 operations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-operations">Custom operations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#nonterminals-in-the-grammar">Nonterminals in the grammar</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-best-hypotheses">The best hypotheses</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#hypotheses-as-functions">Hypotheses as functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lambdas">Lambdas</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#here-s-where-things-get-crazy">Here’s where things get crazy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recursive-functions">Recursive functions</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Fausto Carcassi
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>